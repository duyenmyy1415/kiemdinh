create database QLSACH_BANSACH
use QLSACH_BANSACH
drop database QLSACH_BANSACH
CREATE TABLE TACGIA
(
	MATG CHAR(10) NOT NULL PRIMARY KEY,
	TENTG NVARCHAR(50),
	DiaChi nvarchar(50),
	SDT INT
)
go
CREATE TABLE THELOAI
(
	MATL CHAR(10) NOT NULL PRIMARY KEY,
	TENTL NVARCHAR(50)
)
go
CREATE TABLE NHAXUATBAN
(
	MANXB CHAR(10) NOT NULL PRIMARY KEY,
	TENNXB NVARCHAR(50),
	DIACHI NVARCHAR(50),
	SDT INT
)
go
CREATE TABLE SACH
(
	MASACH CHAR(10) NOT NULL PRIMARY KEY,
	MANXB CHAR(10) NOT NULL,
	MATG CHAR(10) NOT NULL,	
	MATL CHAR(10) NOT NULL,
	TENSACH NVARCHAR(50),	
	GIABAN INT,
	SOLUONG INT,
	CONSTRAINT FK_SACH_TACGIA FOREIGN KEY (MATG) REFERENCES TACGIA(MATG),
	CONSTRAINT FK_SACH_NHAXUATBAN FOREIGN KEY (MANXB) REFERENCES NHAXUATBAN(MANXB),
	CONSTRAINT FK_SACH_THELOAI FOREIGN KEY (MATL) REFERENCES THELOAI(MATL)
)



CREATE TABLE NHANVIEN
(
	MANV CHAR(10) NOT NULL PRIMARY KEY,
	HOTEN NVARCHAR(50),
	NGAYSINH DATE,
	GIOITINH NVARCHAR(5),
	LUONG INT,
	SDT INT,
	TAIKHOAN CHAR(50),
	MATKHAU CHAR(50),
)


CREATE TABLE KHACHHANG
(
	MAKH CHAR(10) NOT NULL PRIMARY KEY,
	TENKH NVARCHAR(50),
	NGAYSINH DATE,
	GIOITINH NVARCHAR(5),
	SDT INT,
	TAIKHOAN CHAR(50),
	MATKHAU CHAR(50),
	DIACHI NVARCHAR(50)
)


CREATE TABLE HOADON
(
	MAHD int identity(1,1) NOT NULL PRIMARY KEY,
	MAKH char(10),
	MANV char(10),
	NGAYHD DATE,
	TONGTIEN INT,
	CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
	CONSTRAINT FK_CHITIETHD_SACH FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)

create table ChiTietHD
(
	MACTHD int identity(1,1) primary key,
	MAHD int,
	MASACH CHAR(10),
	SOLUONG INT,
	GIABAN INT,
	THANHTIEN INT,
	CONSTRAINT FK_CTHD_SACH FOREIGN KEY (MASACH) REFERENCES SACH(MASACH),
	CONSTRAINT FK_CTHD_HD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD)
)


CREATE TABLE PHIEUNHAP
(
	MAPN int identity(1,1) NOT NULL PRIMARY KEY,
	MANV CHAR(10),
	NGAYNHAP DATE,
	TONGTIEN INT,	
	CONSTRAINT FK_PHIEUNHAP_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
)

create table CHITIETPHIEUNHAP
(	
	MAPN int,
	MASACH CHAR(10),
	SOLUONG INT,
	GIANHAP INT,
	THANHTIEN INT,
	CONSTRAINT CHITIETPHIEUNHAP PRIMARY KEY (MASACH,MAPN),
	CONSTRAINT FK_CTPN_PHIEUNHAP FOREIGN KEY (MAPN) REFERENCES PHIEUNHAP(MAPN),
	CONSTRAINT FK_CTPN_SACH FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)
)

insert into NHAXUATBAN values ('NXB1', N'Nhà xuất bản Trẻ', N'124 Nguyễn Văn Cừ Q.1 Tp.HCM', N'1900156045')
insert into NHAXUATBAN values ('NXB2', N'NXB Thống kê', N'Biên Hòa-Đồng Nai', N'1900151112')
insert into NHAXUATBAN values ('NXB3', N'Kim đồng', N'Tp.HCM', N'1900157090')
insert into NHAXUATBAN values ('NXB4', N'Đại học quốc gia', N'Tp.HCM', N'0908419981')
insert into NHAXUATBAN values ('NXB5', N'Văn hóa nghệ thuật', N'Đà Nẵng', N'0903118833')
insert into NHAXUATBAN values ('NXB6', N'Văn hóa', N'Bình Dương', N'0913336677')
insert into NHAXUATBAN values ('NXB7', N'NXB Lao động - Xã hội', N'Tp.HCM', N'0989888888')
insert into NHAXUATBAN values ('NXB8', N'Khoa Học & Kỹ Thuật', N'Hà Nội', N'0903118824')
insert into NHAXUATBAN values ('NXB9', N'Thanh Niên', N'Tp.HCM', N'0903118811')
insert into NHAXUATBAN values ('NXB10', N'NXB Tài Chính', N'Huế', N'0903118833')

INSERT into TACGIA values ('TG1', N'Tenzin Gyatso', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG2', N'Trịnh Xuân Thuận', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG3', N'Matthieu Ricard', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG4', N'Rinpoche', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG5', N'GYALWANG DRUKPA XII', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG6', N'Nguyên Phong', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG7', N'Lama Zopa', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG8', N'Govinda', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG9', N'Trí Hải', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')
INSERT into TACGIA values ('TG10', N'Ngọc Bích', N'179 Chánh Hưng F.4 Q.8 Tp.HCM', N'123456789')

INSERT INTO THELOAI VALUES('TL1',N'giáo dục')
INSERT INTO THELOAI VALUES('TL2',N'hướng dẫn')
INSERT INTO THELOAI VALUES('TL3',N'chính trị')
INSERT INTO THELOAI VALUES('TL4',N'văn học')
INSERT INTO THELOAI VALUES('TL5',N'sách giải')

select * from SACH

INSERT INTO SACH VALUES('SH1','NXB1','TG1','TL1',N'sách văn học',15000,50)
INSERT INTO SACH VALUES('SH2','NXB2','TG2','TL1',N'sách giải toán',20000,30)
INSERT INTO SACH VALUES('SH3','NXB3','TG3','TL2',N'sách sinh học',30000,20)
INSERT INTO SACH VALUES('SH4','NXB4','TG4','TL2',N'sách anh văn B1',45000,10)
INSERT INTO SACH VALUES('SH5','NXB5','TG5','TL3',N'sách anh văn B2',45000,10)
INSERT INTO SACH VALUES('SH6','NXB6','TG6','TL3',N'sách GDCD',15000,50)
INSERT INTO SACH VALUES('SH7','NXB7','TG7','TL4',N'sách mác-lênin',20000,60)
INSERT INTO SACH VALUES('SH8','NXB8','TG8','TL4',N'sách luyện công nghệ thông tin',30000,30)
INSERT INTO SACH VALUES('SH9','NXB9','TG9','TL5',N'sách hướng đối tượng',15000,50)
INSERT INTO SACH VALUES('SH10','NXB10','TG10','TL5',N'sách ôn thi thpt',50000,100)

go
select * from NHANVIEN
select * from Sach where MASACH = 'SH1'

select * from sach





select * from NHANVIEN







select* from KHACHHANG

INSERT INTO NHANVIEN VALUES('NV1',N'Lê Quang Trung','2000/04/01',N'nam',6000000,'0764369836','trung','123')
INSERT INTO NHANVIEN VALUES('NV2',N'Nguyễn Thị Mỹ Duyên','2000/01/01',N'nữ',6000000,'123456789','duyen','123')
INSERT INTO NHANVIEN VALUES('NV3',N'Thái Minh Đạt','2000/01/01',N'nam',6000000,'987654321','dat','123')



INSERT INTO KHACHHANG VALUES('KH1',N'Nguyễn Thị Bảo Trân','2000/02/16',N'nữ','0358859490','tran','123',N'an giang')
INSERT INTO KHACHHANG VALUES('KH2',N'Nguyễn Cao Long','2000/01/01',N'nam','123456789','long','123',N'sài gòn')
INSERT INTO KHACHHANG VALUES('KH3',N'Nguyễn Bí Đỏ','2000/01/01',N'nam','987654321','do','123',N'bến tre')
INSERT INTO KHACHHANG VALUES('KH4',N'Nguyễn Dưa Hấu','2000/02/16',N'nam','0358859490','hau','123',N'bình định')
INSERT INTO KHACHHANG VALUES('KH5',N'Nguyễn heo con','2000/01/01',N'nữ','123456789','con','123',N'hà nội')




select * from Sach




select * from HOADON
select * from ChiTietHD
INSERT INTO HOADON VALUES('KH1','NV1','2021/5/23',15000)



create trigger capnhatTongTien
on ChiTIetHD
FOR INSERT, UPDATE
AS
	UPDATE HOADON
	SET TONGTIEN = (SELECT SUM(ChiTietHD.THANHTIEN) FROM ChiTietHD WHERE ChiTietHD.MAHD = (SELECT MAHD FROM inserted))
	WHERE HOADON.MAHD = (SELECT MAHD FROM inserted)
GO
create proc ThanhTien 
------------TABLE SACH-----------


create view THONGTINSACH
as
	select MASACH, TENSACH, TENTL, TENTG, TENNXB, GIABAN, SOLUONG
	from SACH, TACGIA, NHAXUATBAN, THELOAI
	where SACH.MATG = TACGIA.MATG and SACH.MANXB = NHAXUATBAN.MANXB and SACH.MATL = THELOAI.MATL
go

select * from THONGTINSACH


------------TABLE HOADON-----------

create view THONGTINHD
AS
	SELECT  HOADON.MAHD, SACH.TENSACH, KHACHHANG.TENKH, HOADON.NGAYHD, ChiTietHD.SOLUONG, HOADON.TONGTIEN, ChiTietHD.THANHTIEN
	FROM HOADON, KHACHHANG, SACH, ChiTietHD
	WHERE HOADON.MAKH = KHACHHANG.MAKH AND HOADON.MAHD = ChiTietHD.MAHD and ChiTietHD.MASACH = SACH.MASACH
	GROUP BY HOADON.MAHD
GO

select * from THONGTINHD











